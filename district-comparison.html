<!doctype html>
<html lang="en">
<head>	
	
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	
	<style type="text/css">
		#contentarea {
			border: solid black 1px;
			width: 100%;
			
		}
	
		#contentarea CAPTION {
			text-align: center;
		}
		
		#contentarea .legendbox {
			width: 1em;
			height: 1em;
			border: solid black 1px;
			display: inline-block;
		}
		
		#contentarea TR {
			border-top: 1px solid black;
			border-collapse: collapse;
		}
		
		.smedley {
			background-color: #772432;
			color: #ffffff;
		}

		.presidents_distinguished {
			background-color: #004165;
			color: #ffffff;
		}

		.select_distinguished {
			background-color: #f2df74;
		}

		.distinguished {
			background-color: #a9b2b1;
		}

		
	</style>
	
	<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
	<script src="https://code.pachogrande.com/jqueryui-bootstrap-bridge.js"></script>
	
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	
	<script src="js/leotools-common.js"></script>
		
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<title>Toastmasters District Comparison</title>
	
</head>
<body>

<table id=contentarea class="">
	
</table>

<script>
	
		var LT = new Leotools();
		var urls = {
			"2018-2019"   : LT.current_district_summary_url(),
			"2017-2018" : "http://dashboards.toastmasters.org/2017-2018/export.aspx?type=CSV&report=districtsummary~6/30/2018~~2017-2018",
			"2016-2017" : "http://dashboards.toastmasters.org/2016-2017/export.aspx?type=CSV&report=districtsummary~6/30/2017~~2016-2017",
			"2015-2016" : "http://dashboards.toastmasters.org/2015-2016/export.aspx?type=CSV&report=districtsummary~6/30/2016~~2015-2016",
			"2014-2015" : "http://dashboards.toastmasters.org/2014-2015/export.aspx?type=CSV&report=districtsummary~6/30/2015~~2014-2015",
			"2013-2014" : "http://dashboards.toastmasters.org/2013-2014/export.aspx?type=CSV&report=districtsummary~6/30/2014~~2013-2014",
			"2012-2013" : "http://dashboards.toastmasters.org/2012-2013/export.aspx?type=CSV&report=districtsummary~6/30/2013~~2012-2013",
			"2011-2012" : "http://dashboards.toastmasters.org/2011-2012/export.aspx?type=CSV&report=districtsummary~6/30/2012~~2011-2012",
			"2010-2011" : "http://dashboards.toastmasters.org/2010-2011/export.aspx?type=CSV&report=districtsummary~6/30/2011~~2010-2011",
			"2009-2010" : "http://dashboards.toastmasters.org/2009-2010/export.aspx?type=CSV&report=districtsummary~6/30/2010~~2009-2010",
			"2008-2009" : "http://dashboards.toastmasters.org/2008-2009/export.aspx?type=CSV&report=districtsummary~6/30/2009~~2008-2009",		
		};
		var years = ["2018-2019", "2017-2018", "2016-2017", "2015-2016", "2014-2015", "2013-2014", "2012-2013", "2011-2012", "2010-2011", "2009-2010", "2008-2009"];
		window.years = years;

		for(i=0; i<years.length; i++)
		{
			year = years[i];
			proxy_url = LT.cors_proxy + urls[ year ];
			console.log("setting year=" + year + " with url=" + proxy_url);
			
			$.ajax({
			  url: proxy_url,
			  method: "GET",
			  dataType: "html",
			  success: function(res) {
			  	// Extract the year from the URL as we can't rely on the variables asynchronously 			  	
			  	year = this.url;
			  	year = year.substring( year.length - 9, year.length );

			  	console.log("Successful pull of " + year + " via AJAX");
			  	
			  	jsonArray = jQuery.parseJSON(res);
			  	
			  	columns = jsonArray[0];
			  	coldefs = [];
			  	for(i=0; i<columns.length; i++)
			  	{
			  		baseStr = columns[i];
			  		baseStr = baseStr.replace(/[.@#$%\^&*=_+"'\/<>\\\|{}\[\]]/g,"");
					baseStr = baseStr.replace(/[\t ]+/g,'');
	        		baseStr = baseStr.replace(/\n{1,}/g,'');
	        		baseStr = baseStr.toLowerCase();
	        		
	        		// console.log(baseStr);		  				  		
			  		columns[i] = baseStr;
			  		
			  	}
			  	
			  	// Shift the header row from the data
				jsonArray.shift();
				
				// The last two rows indicate when the information was pulled, pop them out of the way before rendering
				jsonArray.pop();
			  	jsonArray.pop();
			  				  	
				console.log('data has ' + jsonArray.length + ' items in it');
		
				$.each( jsonArray, function( key, v ) {
	
					if(!window.districts)
					{
						window.districts = {};
					}
						
					if(window.districts[ v[1] ])
					{
						window.districts[v[1]][year] = v;
					}
					else
					{
						window.districts[ v[1] ] = Array();
						window.districts[v[1]][year] = v;
					}									
			 	}); // $.each
			 }
			});								
		}
		
		$(document).ajaxStop(function() {
			$( "#contentarea" ).append("<caption><h1>District Recognition Program</h1>" +
				"<div class='distinguished legendbox'></div> Distinguished&nbsp;&nbsp;" +
				"<div class='select_distinguished legendbox'></div> Select Distinguished&nbsp;&nbsp;" +
				"<div class='presidents_distinguished legendbox'></div> Presidents Distinguished&nbsp;&nbsp;" +
				"<div class='smedley legendbox'></div> Smedley Distinguished&nbsp;&nbsp;" +
				"</caption>");
			
			$( "#contentarea" ).append("<thead><tr id=th_header>" + 
					'<th class="col-xs-1">District' + '</th>' +
					'<th class="col-xs-1" id="th_2018-2019">' + "2018-2019" + '</th>' +
					'<th class="col-xs-1" id="th_2017-2018">' + "2017-2018" + '</th>' +
					'<th class="col-xs-1" id="th_2016-2017">' + "2016-2017" + '</th>' +
					'<th class="col-xs-1" id="th_2015-2016">' + "2015-2016" + '</th>' +
					'<th class="col-xs-1" id="th_2014-2015">' + "2014-2015" + '</th>' +
					'<th class="col-xs-1" id="th_2013-2014">' + "2013-2014" + '</th>' +
					'<th class="col-xs-1" id="th_2012-2013">' + "2012-2013" + '</th>' +
					'<th class="col-xs-1" id="th_2011-2012">' + "2011-2012" + '</th>' +
					'<th class="col-xs-1" id="th_2010-2011">' + "2010-2011" + '</th>' +
					'<th class="col-xs-1" id="th_2009-2010">' + "2009-2010" + '</th>' +
					'<th class="col-xs-1" id="th_2008-2009">' + "2008-2009" + '</th>' +
					"</tr></thead>");
			
			$( "#contentarea" ).append("<tbody>");
			//console.log(Object.keys(window.districts).sort() );
			
			for(district in window.districts)
			{
				// 00 => "region"
				// 01 => "district"
				// 02 => "dsp"
				// 03 => "training"
				// 04 => "membership_payments_new"
				// 05 => "membership_payments_april"
				// 06 => "membership_payments_october"
				// 07 => "membership_payments_late"
				// 08 => "membership_payments_charter"
				// 09 => "membership_payments_ytd"
				// 10 => "membership_payments_base"
				// 11 => "membership_payments_growth_percent"
				// 13 => "paidclub_base"
				// 13 => "paidclub_ytd"
				// 14 => "paidclub_growth_percent"
				// 15 => "active_clubs"
				// 16 => "distinguished_clubs"
				// 17 => "distinguished_clubs_select"
				// 18 => "distinguished_clubs_president"
				// 19 => "distinguished_clubs_total"
				// 20 => "distinguished_clubs_percent"
									
				$( "#contentarea" ).append("<tr id=district_" + district + ">" + 
					'<td class="col-xs-1">District ' + district + '</td>' +
					'<td class="col-xs-1" id="' + (district+"_"+"2018-2019") + '">' + "" + '</td>' +
					'<td class="col-xs-1" id="' + (district+"_"+"2017-2018") + '">' + "" + '</td>' +
					'<td class="col-xs-1" id="' + (district+"_"+"2016-2017") + '">' + "" + '</td>' +
					'<td class="col-xs-1" id="' + (district+"_"+"2015-2016") + '">' + "" + '</td>' +
					'<td class="col-xs-1" id="' + (district+"_"+"2014-2015") + '">' + "" + '</td>' +
					'<td class="col-xs-1" id="' + (district+"_"+"2013-2014") + '">' + "" + '</td>' +
					'<td class="col-xs-1" id="' + (district+"_"+"2012-2013") + '">' + "" + '</td>' +
					'<td class="col-xs-1" id="' + (district+"_"+"2011-2012") + '">' + "" + '</td>' +
					'<td class="col-xs-1" id="' + (district+"_"+"2010-2011") + '">' + "" + '</td>' +
					'<td class="col-xs-1" id="' + (district+"_"+"2009-2010") + '">' + "" + '</td>' +
					'<td class="col-xs-1" id="' + (district+"_"+"2008-2009") + '">' + "" + '</td>' +
					"</tr>");
					
				for( year in window.districts[district])
				{
//					console.log(year + ' for ' + district);
					key = (district + "_" + year);
					$("#" + key).html(
						'MP%' + parseFloat(window.districts[district][year][11]) + '<br>' +
						'PC%' + parseFloat(window.districts[district][year][14]) + '<br>' +
						'DC%' + parseFloat(window.districts[district][year][20]) + '<br>'
					);
					
					$("#" + key).attr('data-dsp', window.districts[district][year][2] );
					$("#" + key).attr('data-training', window.districts[district][year][3] );					
					$("#" + key).attr('data-membership_payments_growth_percent', parseFloat( window.districts[district][year][11] ));
					$("#" + key).attr('data-paidclub_growth_percent', parseFloat( window.districts[district][year][14] ));					
					$("#" + key).attr('data-distinguished_clubs_percent', parseFloat( window.districts[district][year][20] ));
					
					if( 
						($("#" + key).attr('data-dsp') == 'Y') &&
						($("#" + key).attr('data-training') == 'Y') &&
						($("#" + key).attr('data-membership_payments_growth_percent') >= 8.00) &&
						($("#" + key).attr('data-paidclub_growth_percent') >= 8.00) &&
						($("#" + key).attr('data-distinguished_clubs_percent') >= 55.00)												
					)
					{
						$("#" + key).attr('data-distinguished', 'smedley');
					}					
					else if( 
						($("#" + key).attr('data-dsp') == 'Y') &&
						($("#" + key).attr('data-training') == 'Y') &&
						($("#" + key).attr('data-membership_payments_growth_percent') >= 5.00) &&
						($("#" + key).attr('data-paidclub_growth_percent') >= 5.00) &&
						($("#" + key).attr('data-distinguished_clubs_percent') >= 50.00)												
					)
					{
						$("#" + key).attr('data-distinguished', 'presidents_distinguished');
					}
					else if( 
						($("#" + key).attr('data-dsp') == 'Y') &&
						($("#" + key).attr('data-training') == 'Y') &&
						($("#" + key).attr('data-membership_payments_growth_percent') >= 3.00) &&
						($("#" + key).attr('data-paidclub_growth_percent') >= 3.00) &&
						($("#" + key).attr('data-distinguished_clubs_percent') >= 45.00)												
					)
					{
						$("#" + key).attr('data-distinguished', 'select_distinguished');
					}
					else if( 
						($("#" + key).attr('data-dsp') == 'Y') &&
						($("#" + key).attr('data-training') == 'Y') &&
						($("#" + key).attr('data-membership_payments_growth_percent') >= 1.5) &&
						($("#" + key).attr('data-paidclub_growth_percent') >= 1.5) &&
						($("#" + key).attr('data-distinguished_clubs_percent') >= 40.00)												
					)
					{
						$("#" + key).attr('data-distinguished', 'distinguished');
					}
					else
					{
						$("#" + key).attr('data-distinguished', 'not');
					}
					
				}
				
				$( 'td').each(function(key,value) {

					if( ($(value).attr('data-distinguished') == 'smedley') )
					{
						$(value).addClass('smedley');
					}					
					else if( ($(value).attr('data-distinguished') == 'presidents_distinguished') )
					{
						$(value).addClass('presidents_distinguished');
					}
					else if( ($(value).attr('data-distinguished') == 'select_distinguished')												
					)
					{
						$(value).addClass('select_distinguished');
					}
					else if( ($(value).attr('data-distinguished') == 'distinguished')												
					)
					{
						$(value).addClass('distinguished');
					}
					
				}); //$( 'td').each(function(key,value)
			} // for(district in window.districts)
			
			$( "#contentarea" ).append("</tbody>");
						
		});		
		
		


	
</script>

</body>
</html>
